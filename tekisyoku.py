import streamlit as st
import pandas as pd

# --- 診断結果の定義 ---
RESULTS_MAP = {
    1: "管理職",
    2: "特別養護老人ホーム",
    3: "有料老人ホーム",
    4: "介護老人保健施設",
    5: "訪問介護",
    6: "デイサービス",
    7: "グループホーム",
    8: "居宅（在宅）",
    9: "施設のケアマネジャー",
    10: "サービス付き高齢者向け住宅や小規模多機能型居宅介護など"
}

# --- スコアリングロジック ---
# 最終合意の対応表に基づき、選択肢('A'または'B')と加算される結果IDのリストを定義
SCORING_RULES = {
    'Q1': {'A': [1, 9], 'B': [2, 3, 4, 5, 6, 7, 10]},
    'Q2': {'A': [1], 'B': [2, 4, 5, 8, 9]},
    'Q3': {'A': [1], 'B': [2, 3, 4, 6, 7]},
    'Q4': {'A': [8, 9], 'B': [2, 3, 4, 7]},
    'Q5': {'A': [7], 'B': [2, 3]},
    'Q6': {'A': [5], 'B': [2, 3, 4, 6, 7, 10]},
    'Q7': {'A': [4], 'B': [6]},
    'Q8': {'A': [2, 3, 4], 'B': [10]},
    'Q9': {'A': [2, 3, 4, 5, 6, 7, 8, 9, 10], 'B': [1]}, 
    'Q10': {'A': [1], 'B': [2, 3, 4, 5, 6, 7, 8, 9, 10]}
}

# --- 質問リスト ---
QUESTIONS = [
    ("Q1", "働く上で最も重視するのは？", 
     "組織全体の効率を考え、仕組みを改善・管理すること。", 
     "利用者一人ひとりの暮らしに寄り添い、身体介護を丁寧に提供すること。"),
    ("Q2", "困難な状況での自分の強みは？", 
     "感情的にならず、安定した精神で業務を淡々と遂行できる。", 
     "専門性を活かし、課題解決のために活発に意見を出し、行動できる。"),
    ("Q3", "上司や組織の方針への態度は？", 
     "自分の意見とは違っても、まずは上司の指示に従い、それを実行する。", 
     "納得できない点があれば、改善を求めて積極的に自分の考えを主張する。"),
    ("Q4", "理想とするサービス提供は？", 
     "居宅（自宅）での生活を支えるため、外部サービスを計画・調整する。", 
     "施設（入居）での生活全般を支えるため、チームで深く関わる。"),
    ("Q5", "利用者さんとの関わり方で好むのは？", 
     "小規模な環境で、認知症の方と家庭的に深く関わる。", 
     "大規模な環境で、医療ニーズの高い方や看取りまで支援する。"),
    ("Q6", "サービス提供の「時間」として好むのは？", 
     "利用者さんの自宅を訪問し、短時間・一対一の支援を行う。", 
     "施設や事業所で、日中または24時間体制で勤務する。"),
    ("Q7", "サービスの目的として共感するのは？", 
     "在宅復帰やリハビリを重視し、自立を促す集中的な支援。", 
     "生活の継続を第一に、日々の活動を一緒に楽しみ、レクリエーションを行う。"),
    ("Q8", "職場の「雰囲気」として理想的なのは？", 
     "多くの専門職が連携し、医療的ケアにも対応できる手厚い環境。", 
     "職員数が少なく、地域との連携も活発な複合的なサービスを提供する環境。"),
    ("Q9", "自分の人柄を表すならどちら？", 
     "積極的に前に出て引っ張るリーダーシップがある。", 
     "誰に対しても温厚で人当たりが良く、穏やかに接することができる。"),
    ("Q10", "仕事における自身の成長意欲は？", 
     "現状維持を望み、ストレスに鈍感でいることの安定性を重視する。", 
     "専門性を常に高め、新しい知識や技術の習得に意欲的に取り組む。"),
]

# --- 診断結果メッセージ ---
MESSAGES = {
    "管理職": "🎉 天性のマネジメント気質！あなたは、**感情に左右されず冷静で、指示を素直に実行できるプロの裏方**です。現場の主役になるより、組織の平和と安定を最優先できます。全体のバランスを取り、大きな組織を円滑に動かす仕事にこそ、あなたの才能が輝きます！",
    "特別養護老人ホーム": "💖 究極の「終活」サポーター！あなたは利用者さんの**最後の暮らし**まで、とことん深く関わりたい情熱家！重度の身体介護や看取りも含め、24時間365日、生活すべてを支えるのがミッション。**濃い人間関係とチームの絆**の中で、最高のやりがいを感じられます！",
    "有料老人ホーム": "✨ サービス業のプロ！あなたは**快適さやホテルのような質**を追求するのが得意。施設での長期生活をトータルでコーディネートし、利用者さんの満足度を上げたい欲求が強いです。大規模で洗練された環境で、**手厚く、行き届いた**ケアを提供するのが天職です！",
    "介護老人保健施設": "💪 リハビリの鬼！**在宅復帰**という目標に向けて、利用者をスパルタ...ではなく（笑）、集中的にサポートするのがあなた！医療とリハビリが一体となった環境で、**回復プロセス**を見るのが大好き。利用者さんの**卒業**を心から喜べる、前向きな人に向いています！",
    "訪問介護": "🚗 孤高のケア職人！あなたは**一匹狼**タイプ！誰にも邪魔されず、利用者さんと**一対一**でじっくり向き合いたい。利用者さんの自宅というプライベートな空間で、細かなニーズに対応する**自律性や責任感**がピカイチ。フットワーク軽く働きたい人に最適です！",
    "デイサービス": "🎨 ムードメーカー！あなたは利用者さんを**笑顔にするのが得意なエンターテイナー！**日中の限られた時間で、レクリエーションやイベントを楽しみ、活気ある時間を作るのが使命です。夜勤もないため、**仕事とプライベートのメリハリ**をつけたい人にぴったりです！",
    "グループホーム": "🏡 家庭的な癒やし担当！あなたは**大規模な場所が苦手なアットホーム志向**。少人数で家族のような関係性を築き、特に**認知症の方**に対して愛情深く寄り添うことができます。ゆっくりとした時間の中で、暮らしの質を上げたいと考える方に天職です。",
    "居宅（在宅）": "🗺️ 地域の司令塔！あなたは**調整役と計画作りが得意な戦略家**！現場で働くよりも、利用者さんの自宅生活に必要な**パズルのピース**（様々なサービス）を組み合わせて、最高の在宅プランを作ることに情熱を燃やします。全体を見て動かしたいあなたに最適です！",
    "施設のケアマネジャー": "📝 施設内の調整マニア！あなたは現場の経験と**計画作成**のスキルを掛け合わせたいタイプ。施設内で他の職員と連携を取りながら、利用者さん全員のケアプランを完璧に管理したい。**全体を統括するポジション**で、あなたの緻密さが役立ちます！",
    "サービス付き高齢者向け住宅など": "🌐 ハイブリッドな働き方！あなたは**一つの枠に収まりたくない自由人！**入居サービスも通所サービスも提供する複合的な環境で、幅広いスキルを身につけたい。地域との関わりも深く、**多様な働き方**や新しい介護サービスにチャレンジしたい方にぴったりです！"
}

# --- スコア計算関数 ---
def calculate_score(answers):
    scores = {id: 0 for id in RESULTS_MAP.keys()}
    
    for q_name, answer in answers.items():
        if q_name in SCORING_RULES and answer in SCORING_RULES[q_name]:
            for result_id in SCORING_RULES[q_name][answer]:
                scores[result_id] += 1
    
    # スコアを降順にソートし、結果名とスコアをペアにする
    ranked_results = sorted(
        [(scores[id], RESULTS_MAP[id]) for id in scores.keys()],
        key=lambda x: x[0],
        reverse=True
    )
    return ranked_results

# --- Streamlit UIの構築 ---
st.set_page_config(layout="wide") # 画面幅を広く使う
st.title("👨‍⚕️ 介護職の適職診断（全10問）")
st.markdown("ご自身の考えに最も近いものを選んでください。")
st.divider()

if 'answers' not in st.session_state:
    st.session_state.answers = {}

# 質問の表示
with st.form(key='aptitude_form'):
    for q_code, q_title, choice_a, choice_b in QUESTIONS:
        st.subheader(f"{q_code}. {q_title}")
        
        # 選択肢の表示をAとBのコード名ではなく、テキストで表示
        options_text = [choice_a, choice_b]
        options_code = ["A", "B"]
        
        # Streamlitのラジオボタン
        option = st.radio(
            label="選択してください",
            options=options_code,
            format_func=lambda x: options_text[options_code.index(x)],
            key=q_code,
            index=None, 
            label_visibility='collapsed' 
        )
        st.session_state.answers[q_code] = option

    st.markdown("---")
    submitted = st.form_submit_button("診断結果を見る 🚀")

# 結果の表示ロジック
if submitted:
    # 全ての質問に回答しているかチェック
    if any(ans is None for ans in st.session_state.answers.values()):
        st.error("全ての質問に回答してください。")
    else:
        # スコア計算
        ranked_results = calculate_score(st.session_state.answers)
        
        main_score = ranked_results[0][0]
        
        # 第一適職（同点含む）を抽出
        main_results = [name for score, name in ranked_results if score == main_score]
        
        # 2位以下の結果を抽出
        top_other_results = [(score, name) for score, name in ranked_results if score < main_score]
        
        st.balloons()
        st.success("## 診断完了！あなたの適職タイプは...")
        
        # -------------------
        # 第一適職の表示 (スコア表示なし)
        # -------------------
        main_results_text = '、'.join([f"【{name}】" for name in main_results])
        st.markdown(f"**🥇 第一適職**: **{main_results_text}**")

        
        # -------------------
        # 詳細な診断テキストの表示
        # -------------------
        
        # メインの結果が一つだけの場合、その詳細メッセージを表示
        if len(main_results) == 1:
            main_job = main_results[0]
            st.warning(MESSAGES.get(main_job, "最適な結果が見つかりました！"))
        
        else:
            # 同点の結果が複数ある場合の汎用メッセージ
            st.warning(f"あなたは複数の職種（{main_results_text}）に、同じくらい高い適性を持っています！どの分野でも力を発揮できる万能タイプです。")

        st.divider()
        st.subheader("💡 他の適職候補")
        
        # その他の適職を表示 (スコア表示なし)
        if top_other_results:
            st.write("以下もあなたの可能性を広げる職種です。")
            
            # スコアが同じものに同じ順位をつけ、重複を削除して表示
            current_rank = len(main_results) + 1
            
            for score, name in top_other_results:
                st.write(f"**候補{current_rank}位**：{name}")
                # スコアが変わらない限り順位を上げない (同点処理はここで簡略化)
                if score != top_other_results[0][0]:
                    current_rank += 1 
                
        else:
            st.write("他の職種も全体的に高い適性を持っています！すべての職種で高い潜在能力があります。")
